<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AeroCode - Pro Python IDE</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/dracula.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/eclipse.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/closebrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/matchbrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/python-hint.min.js"></script>

    <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-XXXXXXXXXXXXXXXX" crossorigin="anonymous"></script>

    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <style>
        :root {
            --bg-color: #050505; /* M√©ly fekete az OLED hat√°shoz */
            --text-color: #e0e0e0;
            --panel-bg: #121212;
            --border-color: #2b2b2b;
            --accent-color: #2196F3;
            --output-bg: #0a0a0a;
            
            /* Glass Variables */
            --glass-bg: rgba(20, 20, 20, 0.65);
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
            --glass-blur: 20px;
            
            --btn-hover: rgba(255, 255, 255, 0.1);
            --run-color: #2196F3;
            --run-glow: rgba(33, 150, 243, 0.6);

            --hint-bg: #252526;
            --hint-text: #e0e0e0;
            --hint-select-bg: #0e639c;
            --hint-select-text: #ffffff;
            
            --xp-color: #ff9800;
            --lvl-bg: linear-gradient(135deg, #ff9800, #f44336);
        }

        body.light-mode {
            --bg-color: #f5f5f7;
            --text-color: #333333;
            --panel-bg: #ffffff;
            --border-color: #d1d1d1;
            --output-bg: #ffffff;
            --glass-bg: rgba(255, 255, 255, 0.65);
            --glass-border: rgba(0, 0, 0, 0.05);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
            --btn-hover: rgba(0, 0, 0, 0.05);
            --run-color: #1976D2;
            --run-glow: rgba(25, 118, 210, 0.4);
            --hint-bg: #f3f3f3;
            --hint-text: #333333;
            --hint-select-bg: #b4d7ff;
            --hint-select-text: #000000;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0; padding: 0;
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            overflow: hidden;
            position: relative;
            transition: background 0.3s ease;
        }

        /* --- INTRO ANIMATION STYLES --- */
        #intro-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #000;
            z-index: 999999; /* Mindig legfel√ºl */
            display: flex; justify-content: center; align-items: center;
            overflow: hidden;
        }

        .svg-container {
            width: 300px; height: 300px;
            position: relative;
        }

        .intro-path {
            fill: none;
            stroke: var(--run-color);
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
            stroke-dasharray: 1000;
            stroke-dashoffset: 1000;
        }

        /* Aero Text Animation */
        .aero-text {
            animation: drawPath 1.5s ease-in-out forwards, fadeOut 0.5s ease-in-out 1.8s forwards;
        }

        /* Star Animation */
        .star-shape {
            stroke: #fff;
            stroke-width: 3;
            opacity: 0; /* Kezdetben l√°thatatlan */
            filter: drop-shadow(0 0 10px var(--run-color));
            animation: fadeIn 0.1s linear 1.8s forwards, drawPath 1.5s ease-in-out 1.8s forwards, expandStar 0.8s ease-in 3.2s forwards;
            transform-origin: center;
        }

        @keyframes drawPath {
            to { stroke-dashoffset: 0; }
        }

        @keyframes fadeOut {
            to { opacity: 0; transform: scale(0.9); }
        }

        @keyframes fadeIn {
            to { opacity: 1; }
        }

        @keyframes expandStar {
            0% { transform: scale(1) rotate(0deg); opacity: 1; stroke-width: 3; }
            100% { transform: scale(20) rotate(45deg); opacity: 0; stroke-width: 0; }
        }

        @keyframes fadeLayer {
            to { opacity: 0; visibility: hidden; }
        }

        /* --- AUTH LOGIN MODAL (MODERNIZED) --- */
        #auth-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(15px);
            z-index: 99999; 
            display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; /* Kezdetben rejtve az intro miatt */
            transition: opacity 0.8s ease;
        }

        .auth-box {
            background: rgba(30, 30, 30, 0.6);
            border: 1px solid rgba(255,255,255,0.1);
            width: 380px; padding: 40px 30px;
            border-radius: 24px;
            box-shadow: 0 25px 80px rgba(0,0,0,0.6), inset 0 0 20px rgba(255,255,255,0.02);
            text-align: center;
            transform: translateY(20px);
            transition: transform 0.5s ease;
        }

        .auth-title {
            font-family: 'Inter', sans-serif;
            font-weight: 800; font-size: 28px; color: white;
            margin-bottom: 5px; letter-spacing: -1px;
        }
        
        .auth-subtitle { font-size: 12px; color: #888; margin-bottom: 30px; text-transform: uppercase; letter-spacing: 2px; }

        .auth-tabs { display: flex; margin-bottom: 25px; background: rgba(0,0,0,0.3); padding: 4px; border-radius: 12px; }
        .auth-tab { 
            flex: 1; padding: 10px; cursor: pointer; color: #888; 
            border-radius: 8px; transition: all 0.3s; font-size: 13px; font-weight: 600;
        }
        .auth-tab.active { background: var(--accent-color); color: white; box-shadow: 0 4px 15px rgba(33, 150, 243, 0.4); }

        /* Floating Label Inputs */
        .input-group { position: relative; margin-bottom: 20px; text-align: left; }
        .auth-input {
            width: 100%; padding: 15px 15px 5px 15px; height: 50px;
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            color: white; border-radius: 12px; outline: none; font-size: 15px;
            transition: border 0.3s, background 0.3s;
        }
        .auth-input:focus { border-color: var(--accent-color); background: rgba(255,255,255,0.08); }
        
        .input-label {
            position: absolute; left: 15px; top: 16px;
            color: #888; font-size: 14px; pointer-events: none;
            transition: all 0.3s ease;
        }
        
        .auth-input:focus + .input-label,
        .auth-input:not(:placeholder-shown) + .input-label {
            top: 6px; font-size: 10px; color: var(--accent-color); font-weight: bold;
        }

        .auth-btn {
            width: 100%; padding: 14px; background: var(--accent-color);
            color: white; border: none; border-radius: 12px; cursor: pointer;
            font-weight: 700; font-size: 15px; text-transform: uppercase; letter-spacing: 1px;
            box-shadow: 0 10px 30px rgba(33, 150, 243, 0.3);
            transition: all 0.3s;
        }
        .auth-btn:hover { transform: translateY(-2px); box-shadow: 0 15px 40px rgba(33, 150, 243, 0.5); }

        /* --- HEADER & UI --- */
        .header-wrapper { position: fixed; top: 25px; left: 0; width: 100%; display: flex; justify-content: space-between; padding: 0 40px; z-index: 1000; pointer-events: none; }
        .glass-bubble { pointer-events: auto; background: var(--glass-bg); backdrop-filter: blur(var(--glass-blur)); border: 1px solid var(--glass-border); box-shadow: var(--glass-shadow); border-radius: 100px; padding: 6px 10px; display: flex; align-items: center; gap: 10px; transition: transform 0.2s ease; }
        .glass-bubble:hover { transform: translateY(-2px); }
        .app-title { font-weight: 800; font-size: 16px; padding-left: 15px; padding-right: 10px; color: white; display: flex; align-items: center; gap: 8px; }
        .vertical-divider { width: 1px; height: 24px; background-color: var(--border-color); margin: 0 5px; }
        
        button.icon-btn { background: transparent; border: none; color: var(--text-color); width: 42px; height: 42px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; }
        button.icon-btn:hover { background: var(--btn-hover); transform: scale(1.1); color: white; }
        button.run-btn { background: var(--run-color); color: white; border: none; width: 42px; height: 42px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; margin-right: 2px; box-shadow: 0 4px 15px var(--run-glow); transition: all 0.3s; }
        button.run-btn:hover { transform: scale(1.15); box-shadow: 0 6px 25px var(--run-glow); }

        /* Layout */
        .main-container { display: flex; height: 100vh; width: 100%; }
        .editor-container { flex: 6; display: flex; flex-direction: column; border-right: 1px solid var(--border-color); background: transparent; }
        .CodeMirror { flex: 1; font-family: 'JetBrains Mono', monospace; font-size: 14px; background: transparent !important; height: 100%; }
        .CodeMirror-gutters { background: var(--bg-color) !important; border-right: 1px solid var(--border-color); }
        .CodeMirror-scroll { padding-top: 100px; padding-bottom: 50px; }
        
        .side-panel { flex: 4; display: flex; flex-direction: column; background-color: var(--bg-color); min-width: 300px; padding-top: 100px; }
        .panel-header { padding: 8px 20px; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1.2px; opacity: 0.6; margin-bottom: 5px; }
        .terminal-wrapper { flex: 1; display: flex; flex-direction: column; background-color: var(--output-bg); border-radius: 16px; margin: 0 20px 20px 20px; overflow: hidden; border: 1px solid var(--border-color); box-shadow: 0 4px 20px rgba(0,0,0,0.2); }
        #output { flex: 1; padding: 20px; font-family: 'JetBrains Mono', monospace; font-size: 13px; white-space: pre-wrap; overflow-y: auto; color: var(--text-color); }
        
        #adsense-container { height: 35%; margin: 0 20px 20px 20px; background-color: var(--output-bg); border-radius: 16px; border: 1px solid var(--border-color); padding: 10px; overflow: hidden; display: flex; justify-content: center; align-items: center; }
        .ad-placeholder { color: #666; font-size: 12px; font-style: italic; border: 1px dashed #444; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; }

        /* Misc */
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--bg-color); z-index: 9998; display: none; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.5s ease; }
        .gear { width: 60px; height: 60px; fill: var(--accent-color); animation: spin 2s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        
        #terminal-input-bar { display: none; background: var(--panel-bg); padding: 12px; border-top: 1px solid var(--border-color); align-items: center; gap: 10px; }
        #terminal-input-bar.visible { display: flex; }
        #term-input { flex: 1; background: transparent; border: none; color: var(--text-color); outline: none; font-family: 'JetBrains Mono'; font-size: 13px;}
        
        .file-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; border-bottom: 1px solid var(--border-color); cursor: pointer; transition: background 0.2s; font-size: 13px; }
        .file-item:hover { background-color: var(--input-field-bg); }
        .file-info-left { display: flex; align-items: center; gap: 10px; flex: 1; }
        .file-icon { color: var(--accent-color); }
        .file-name { font-weight: 600; color: var(--text-color); }
        .file-tag { background-color: var(--btn-hover); border: 1px solid var(--border-color); padding: 2px 8px; border-radius: 12px; font-size: 11px; color: var(--accent-color); margin-right: 10px; }
        .file-date { font-size: 11px; color: #888; }

        .xp-container { display: flex; align-items: center; gap: 8px; margin-right: 15px; font-family: 'JetBrains Mono', monospace; font-size: 12px; }
        .level-badge { background: var(--lvl-bg); color: white; padding: 2px 8px; border-radius: 12px; font-weight: bold; box-shadow: 0 2px 5px rgba(255, 152, 0, 0.4); }
        .xp-text { color: var(--xp-color); font-weight: 600; }

        .CodeMirror-hints { position: absolute; z-index: 100000; background: var(--hint-bg); border: 1px solid var(--border-color); }
        .dropdown { position: relative; display: inline-block; }
        .dropdown-content { display: none; position: absolute; right: 0; top: 50px; background-color: var(--glass-bg); backdrop-filter: blur(20px); min-width: 160px; border-radius: 12px; border: 1px solid var(--glass-border); z-index: 2000; padding: 5px; }
        .dropdown:hover .dropdown-content { display: block; }
        .dropdown-content a { color: var(--text-color); padding: 10px; text-decoration: none; display: flex; align-items: center; gap: 10px; font-size: 13px; border-radius: 6px; }
        .dropdown-content a:hover { background-color: var(--accent-color); color: white; }

        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10001; backdrop-filter: blur(8px); justify-content: center; align-items: center; }
        .modal { background: var(--modal-bg); width: 500px; padding: 25px; border-radius: 24px; border: 1px solid var(--border-color); box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .modal button { background: var(--accent-color); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; float: right; margin-top: 15px; font-weight: 600; }
        .user-input { color: var(--run-color); font-weight: bold; }
        .error { color: #ff5555; }
        .success { color: #50fa7b; }
    </style>
</head>
<body>

    <div id="intro-layer">
        <div class="svg-container">
            <svg width="300" height="300" viewBox="0 0 300 300">
                <g class="aero-text">
                    <path class="intro-path" d="M 40,200 L 80,50 L 120,200 M 60,140 L 100,140" />
                    <path class="intro-path" d="M 140,200 L 140,50 L 190,50 M 140,125 L 180,125 M 140,200 L 190,200" />
                    <path class="intro-path" d="M 210,200 L 210,50 L 240,50 C 260,50 260,100 240,100 L 210,100 L 250,200" />
                    </g>
                
                <path class="star-shape intro-path" d="M150,20 L185,110 L280,110 L205,170 L235,260 L150,210 L65,260 L95,170 L20,110 L115,110 Z" />
            </svg>
        </div>
    </div>

    <div id="auth-overlay">
        <div class="auth-box">
            <div class="auth-title">AeroCode</div>
            <div class="auth-subtitle">Pro Python IDE</div>
            
            <div class="auth-tabs">
                <div class="auth-tab active" onclick="switchTab('login')">Bejelentkez√©s</div>
                <div class="auth-tab" onclick="switchTab('register')">Regisztr√°ci√≥</div>
            </div>

            <div id="login-form" class="auth-form">
                <div class="input-group">
                    <input type="text" id="login-username" class="auth-input" placeholder=" " autocomplete="off">
                    <label class="input-label">Felhaszn√°l√≥n√©v</label>
                </div>
                <button class="auth-btn" onclick="handleLogin()">Bel√©p√©s</button>
            </div>

            <div id="register-form" class="auth-form" style="display:none;">
                <div class="input-group">
                    <input type="text" id="reg-username" class="auth-input" placeholder=" " autocomplete="off">
                    <label class="input-label">√öj Felhaszn√°l√≥n√©v</label>
                </div>
                <div class="input-group">
                    <input type="password" id="reg-key" class="auth-input" placeholder=" " autocomplete="off">
                    <label class="input-label">Mester Kulcs</label>
                </div>
                <button class="auth-btn" onclick="handleRegister()">Regisztr√°ci√≥</button>
            </div>
            
            <div id="auth-message" style="margin-top:15px; color: #ff5555; font-size:12px; min-height:20px;"></div>
        </div>
    </div>

    <div id="loading-overlay">
        <svg class="gear" viewBox="0 0 512 512"><path d="M495.9 166.6c3.2 8.7 .5 18.4-6.4 24.6l-43.3 39.4c1.1 8.3 1.7 16.8 1.7 25.4s-.6 17.1-1.7 25.4l43.3 39.4c6.9 6.2 9.6 15.9 6.4 24.6c-4.4 11.9-9.7 23.3-15.8 34.3l-4.7 8.1c-6.6 11-14 21.4-22.1 31.2c-5.9 7.2-15.7 9.6-24.5 6.8l-55.7-17.7c-13.4 10.3-28.2 18.9-44 25.4l-12.5 57.1c-2 9.1-9 16.3-18.2 17.8c-13.8 2.3-28 3.5-42.5 3.5s-28.7-1.2-42.5-3.5c-9.2-1.5-16.2-8.7-18.2-17.8l-12.5-57.1c-15.8-6.5-30.6-15.1-44-25.4L83.1 425.9c-8.8 2.8-18.6 .3-24.5-6.8c-8.1-9.8-15.5-20.2-22.1-31.2l-4.7-8.1c-6.1-11-11.4-22.4-15.8-34.3c-3.2-8.7-.5-18.4 6.4-24.6l43.3-39.4C64.6 273.1 64 264.6 64 256s.6-17.1 1.7-25.4L22.4 191.2c-6.9-6.2-9.6-15.9-6.4-24.6c4.4-11.9 9.7-23.3 15.8-34.3l4.7-8.1c6.6-11 14-21.4 22.1-31.2c5.9-7.2 15.7-9.6 24.5-6.8l55.7 17.7c13.4-10.3 28.2-18.9 44-25.4l12.5-57.1c2-9.1 9-16.3 18.2-17.8C227.3 1.2 241.5 0 256 0s28.7 1.2 42.5 3.5c9.2 1.5 16.2 8.7 18.2 17.8l12.5 57.1c15.8 6.5 30.6 15.1 44 25.4l55.7-17.7c8.8-2.8 18.6-.3 24.5 6.8c8.1 9.8 15.5 20.2 22.1 31.2l4.7 8.1c6.1 11 11.4 22.4 15.8 34.3zM256 336a80 80 0 1 0 0-160 80 80 0 1 0 0 160z"/></svg>
        <div style="margin-top:20px; color:#666">M≈±velet folyamatban...</div>
    </div>

    <div class="header-wrapper">
        <div class="glass-bubble left-bubble">
            <div class="app-title"><span style="font-size: 18px;">üêç</span>AeroCode</div>
            <div class="vertical-divider"></div>
            <button class="run-btn" onclick="runPython()" title="Futtat√°s (Ctrl+Enter)"><span class="material-icons">play_arrow</span></button>
        </div>

        <div class="glass-bubble right-bubble">
            <div id="xp-container" class="xp-container" style="display:none;">
                <span id="level-display" class="level-badge">Lvl 1</span>
                <span id="xp-display" class="xp-text">0 XP</span>
            </div>
            
            <span id="user-display" style="font-size:12px; opacity:0.7; margin-right:5px;">Vend√©g</span>
            
            <div class="dropdown">
                <button class="icon-btn" title="Felh≈ë Ment√©s/Bet√∂lt√©s">
                    <span class="material-icons">cloud_queue</span>
                </button>
                <div class="dropdown-content">
                    <a onclick="handleDriveSave()"><span class="material-icons">save</span> Ment√©s Drive-ra</a>
                    <a onclick="handleDriveLoad()"><span class="material-icons">folder_open</span> Bet√∂lt√©s</a>
                </div>
            </div>

            <button class="icon-btn" onclick="toggleTheme()" title="T√©ma"><span class="material-icons">dark_mode</span></button>
            <button class="icon-btn" onclick="downloadCode()" title="Let√∂lt√©s (.txt)"><span class="material-icons">download</span></button>
            <button class="icon-btn" onclick="openSettings()" title="Be√°ll√≠t√°sok"><span class="material-icons">settings</span></button>
        </div>
    </div>

    <div class="main-container">
        <div class="editor-container">
            <textarea id="code-editor">
# AeroCode - Pro Python IDE v15
# üöÄ Modern UI Update & Animation

def start():
    print("Az anim√°ci√≥ ut√°n bet√∂lt≈ëd√∂tt a rendszer.")
    print("Jelentkezz be az XP gy≈±jt√©shez!")

start()
            </textarea>
        </div>

        <div class="side-panel">
            <div class="panel-header">TERMINAL</div>
            <div class="terminal-wrapper">
                <div id="output">Konzol k√©sz. Jelentkezz be a haszn√°lathoz.</div>
                <div id="terminal-input-bar">
                    <span style="color:var(--run-color); font-weight:bold;">></span>
                    <input type="text" id="term-input" autocomplete="off">
                </div>
            </div>
            
            <div class="panel-header">HIRDET√âS</div>
            <div id="adsense-container">
                <div class="ad-placeholder">Google AdSense Helye</div>
                </div>
        </div>
    </div>

    <div id="settingsModal" class="modal-overlay">
        <div class="modal">
            <h3 style="margin-top:0; color:var(--text-color)">Be√°ll√≠t√°sok</h3>
            <p style="color:#888; font-size:13px;">Verzi√≥: 15.0 (Aero)</p>
            <button onclick="closeSettings()" style="background:transparent; margin-right:10px; color:var(--text-color)">Bez√°r√°s</button>
        </div>
    </div>

    <div id="loadModal" class="modal-overlay">
        <div class="modal">
            <h3 style="margin-top:0; color:var(--text-color)">F√°jlok Bet√∂lt√©se</h3>
            <div style="display:flex; justify-content:space-between; padding:5px 15px; font-size:11px; opacity:0.6; color:var(--text-color); border-bottom:1px solid var(--border-color);">
                <span>N√âV & C√çMKE</span><span>M√ìDOS√çTVA</span>
            </div>
            <div id="file-list" style="max-height:300px; overflow-y:auto; margin-bottom:15px; border:1px solid var(--border-color); border-radius:8px; margin-top:5px;"></div>
            <button onclick="document.getElementById('loadModal').style.display='none'" style="background:transparent; color:var(--text-color)">M√©gse</button>
        </div>
    </div>

    <script>
        // --- INTRO ANIMATION LOGIC ---
        window.addEventListener('load', () => {
            setTimeout(() => {
                // 1. Elt√ºntetj√ºk az Intro r√©teget
                const introLayer = document.getElementById('intro-layer');
                introLayer.style.animation = "fadeLayer 0.5s forwards";
                
                // 2. Megjelen√≠tj√ºk a Login r√©teget (√©s enged√©lyezz√ºk a kattint√°st)
                const authOverlay = document.getElementById('auth-overlay');
                authOverlay.style.opacity = "1";
                authOverlay.style.pointerEvents = "all";
                // Kis anim√°ci√≥ a doboznak
                document.querySelector('.auth-box').style.transform = "translateY(0)";
                
                // T√∂r√∂lj√ºk az intro-t a DOM-b√≥l, hogy ne zavarjon
                setTimeout(() => { introLayer.style.display = "none"; }, 500);
            }, 4000); // 4 m√°sodperc ut√°n
        });

        // --- KONFIGUR√ÅCI√ì ---
        const CLIENT_ID = '138100233309-v575n23j2b6pdek9t9clvkg3immlkrdi.apps.googleusercontent.com'; 
        const API_KEY = 'AIzaSyAfC2viqoOsVVjcShnqY2rrRsxdV7WHMEg'; 
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        const MASTER_KEY = "Jaky10c"; 

        // --- EDITOR ---
        let editor = CodeMirror.fromTextArea(document.getElementById("code-editor"), {
            mode: {name: "python", version: 3}, theme: "dracula",
            lineNumbers: true, indentUnit: 4, smartIndent: true, matchBrackets: true, autoCloseBrackets: true,
            extraKeys: { "Ctrl-Space": "autocomplete", "Ctrl-Enter": function() { runPython(); } },
            hintOptions: { completeSingle: false }
        });

        editor.on("keyup", function (cm, event) {
            const excludedKeys = [8, 9, 13, 27, 37, 38, 39, 40, 46]; 
            if (!excludedKeys.includes(event.keyCode) && !cm.state.completionActive) {
                if ((event.keyCode >= 65 && event.keyCode <= 90) || event.keyCode === 190) { 
                    CodeMirror.commands.autocomplete(cm, null, {completeSingle: false});
                }
            }
        });

        // --- AUTH ---
        let currentUser = null; let tokenClient; let gapiInited = false; let gisInited = false;

        function switchTab(tab) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            if(tab === 'login') {
                document.querySelector('.auth-tab:first-child').classList.add('active');
                document.getElementById('login-form').style.display = 'block';
                document.getElementById('register-form').style.display = 'none';
            } else {
                document.querySelector('.auth-tab:last-child').classList.add('active');
                document.getElementById('login-form').style.display = 'none';
                document.getElementById('register-form').style.display = 'block';
            }
            document.getElementById('auth-message').innerText = "";
        }

        function handleLogin() {
            const user = document.getElementById('login-username').value;
            if(!user) return;
            if(localStorage.getItem('user_' + user)) { completeAuth(user); } 
            else { document.getElementById('auth-message').innerText = "Nincs ilyen felhaszn√°l√≥!"; }
        }

        function handleRegister() {
            const user = document.getElementById('reg-username').value;
            const key = document.getElementById('reg-key').value;
            if(!user || !key) { document.getElementById('auth-message').innerText = "T√∂lts ki minden mez≈ët!"; return; }
            if(key === MASTER_KEY) {
                if(localStorage.getItem('user_' + user)) { document.getElementById('auth-message').innerText = "M√°r l√©tezik!"; }
                else { localStorage.setItem('user_' + user, 'active'); completeAuth(user); }
            } else { document.getElementById('auth-message').innerText = "Hib√°s Mester Kulcs!"; }
        }

        function completeAuth(user) {
            currentUser = user;
            document.getElementById('auth-overlay').style.display = 'none';
            document.getElementById('user-display').innerText = user;
            document.getElementById('xp-container').style.display = 'flex';
            addToOutput(`Bejelentkezve mint: ${user}\nGoogle Drive kapcsolat el≈ëk√©sz√≠t√©se...`);
            
            if(gapiInited && gisInited) {
                tokenClient.callback = async (resp) => {
                    if (resp.error !== undefined) throw (resp);
                    addToOutput("Google Fi√≥k sikeresen csatlakoztatva!\n");
                    await ensureUserFolder();
                };
                if (gapi.client.getToken() === null) { tokenClient.requestAccessToken({prompt: 'consent'}); }
                else { ensureUserFolder(); }
            }
        }

        // --- API LOADERS ---
        function gapiLoaded() { gapi.load('client', async () => { await gapi.client.init({ apiKey: API_KEY, discoveryDocs: [DISCOVERY_DOC], }); gapiInited = true; }); }
        function gisLoaded() { tokenClient = google.accounts.oauth2.initTokenClient({ client_id: CLIENT_ID, scope: SCOPES, callback: '', }); gisInited = true; }

        // --- DRIVE & XP LOGIKA ---
        let userFolderId = null;
        let userStats = { xp: 0, level: 1 };
        let statsFileId = null;
        const STATS_FILE_NAME = 'user_stats.json';

        async function ensureUserFolder() {
            showLoading(true);
            try {
                const folderName = `ProPythonIDE_${currentUser}`;
                const response = await gapi.client.drive.files.list({
                    q: `mimeType='application/vnd.google-apps.folder' and name='${folderName}' and trashed=false`,
                    fields: 'files(id, name)',
                });

                if (response.result.files && response.result.files.length > 0) {
                    userFolderId = response.result.files[0].id;
                    addToOutput(`Mappa megtal√°lva: ${folderName}`);
                } else {
                    const fileMetadata = { 'name': folderName, 'mimeType': 'application/vnd.google-apps.folder' };
                    const createRes = await gapi.client.drive.files.create({ resource: fileMetadata, fields: 'id' });
                    userFolderId = createRes.result.id;
                    addToOutput(`√öj mappa l√©trehozva: ${folderName}`);
                }
                await initStatsSystem();
            } catch (err) { addToOutput(`Hiba a Drive el√©r√©skor: ${err.message}`, "error"); }
            showLoading(false);
        }

        async function initStatsSystem() {
            const response = await gapi.client.drive.files.list({
                q: `'${userFolderId}' in parents and name='${STATS_FILE_NAME}' and trashed=false`,
                fields: 'files(id, name)',
            });

            if (response.result.files && response.result.files.length > 0) {
                statsFileId = response.result.files[0].id;
                const fileContent = await gapi.client.drive.files.get({ fileId: statsFileId, alt: 'media' });
                if(fileContent.body) {
                    userStats = typeof fileContent.body === 'string' ? JSON.parse(fileContent.body) : fileContent.result;
                }
                addToOutput(`XP bet√∂ltve: Lvl ${userStats.level} (${userStats.xp} XP)`);
            } else {
                await updateStatsOnDrive(true);
                addToOutput("XP rendszer inicializ√°lva.");
            }
            updateXPUI();
            startXPTimer();
        }

        function startXPTimer() {
            setInterval(() => { addXP(100); }, 300000); 
        }

        function addXP(amount) {
            userStats.xp += amount;
            let calculatedLevel = Math.floor(userStats.xp / 1000) + 1;
            if (calculatedLevel > userStats.level) {
                userStats.level = calculatedLevel;
                addToOutput(`GRATUL√ÅLOK! Szintet l√©pt√©l: Lvl ${userStats.level}`, "success");
            } else {
                addToOutput(`+${amount} XP (√ñsszesen: ${userStats.xp})`, "success");
            }
            updateXPUI();
            updateStatsOnDrive();
        }

        function updateXPUI() {
            const currentLevelBaseXP = (userStats.level - 1) * 1000;
            const xpInCurrentLevel = userStats.xp - currentLevelBaseXP;
            document.getElementById('level-display').innerText = `Lvl ${userStats.level}`;
            document.getElementById('xp-display').innerText = `${xpInCurrentLevel} / 1000 XP`;
        }

        async function updateStatsOnDrive(isNew = false) {
            const content = JSON.stringify(userStats);
            const file = new Blob([content], {type: 'application/json'});
            const accessToken = gapi.client.getToken().access_token;
            const form = new FormData();
            const metadata = { 'name': STATS_FILE_NAME, 'mimeType': 'application/json', };
            if (isNew) metadata.parents = [userFolderId];
            form.append('metadata', new Blob([JSON.stringify(metadata)], {type: 'application/json'}));
            form.append('file', file);
            let url = 'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart';
            let method = 'POST';
            if (!isNew && statsFileId) {
                url = `https://www.googleapis.com/upload/drive/v3/files/${statsFileId}?uploadType=multipart`;
                method = 'PATCH';
            }
            try {
                const res = await fetch(url, { method: method, headers: new Headers({'Authorization': 'Bearer ' + accessToken}), body: form });
                const val = await res.json();
                if(isNew) statsFileId = val.id;
            } catch(err) { console.error("Hiba az XP ment√©sekor:", err); }
        }

        // --- F√ÅJL M≈∞VELETEK ---
        async function handleDriveSave() {
            if(!userFolderId) { alert("Nincs csatlakoztatva Google Drive!"); return; }
            let filename = prompt("Mi legyen a f√°jl neve?", `kod_${new Date().toISOString().slice(0,10)}`);
            if (!filename) return;
            if (!filename.endsWith('.py')) filename += '.py';
            let tag = prompt("Adj meg egy C√≠mk√©t/Projekt nevet (opcion√°lis):", "");

            showLoading(true);
            const content = editor.getValue();
            const file = new Blob([content], {type: 'text/plain'});
            const metadata = { 'name': filename, 'mimeType': 'text/plain', 'parents': [userFolderId], 'properties': { 'custom_tag': tag || "" } };
            const accessToken = gapi.client.getToken().access_token;
            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(metadata)], {type: 'application/json'}));
            form.append('file', file);

            fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                method: 'POST', headers: new Headers({'Authorization': 'Bearer ' + accessToken}), body: form
            }).then(res => res.json()).then(val => {
                addToOutput(`Sikeres ment√©s: ${filename}`, "success"); showLoading(false);
            }).catch(err => { addToOutput("Ment√©si hiba!", "error"); showLoading(false); });
        }

        async function handleDriveLoad() {
            if(!userFolderId) return;
            showLoading(true);
            const response = await gapi.client.drive.files.list({
                q: `'${userFolderId}' in parents and trashed=false`,
                fields: 'files(id, name, modifiedTime, properties)',
            });
            const files = response.result.files;
            const listDiv = document.getElementById('file-list');
            listDiv.innerHTML = "";
            if (files && files.length > 0) {
                files.forEach(file => {
                    if(file.name === STATS_FILE_NAME) return;
                    let dateObj = new Date(file.modifiedTime);
                    let formattedDate = dateObj.toLocaleString('hu-HU', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                    let tagHtml = "";
                    if (file.properties && file.properties.custom_tag) { tagHtml = `<span class="file-tag">${file.properties.custom_tag}</span>`; }
                    const div = document.createElement('div');
                    div.className = "file-item";
                    div.onclick = () => loadFileContent(file.id);
                    div.innerHTML = `<div class="file-info-left"><span class="material-icons file-icon">description</span><div><div class="file-name">${file.name}</div></div></div><div style="display:flex; align-items:center;">${tagHtml}<span class="file-date">${formattedDate}</span></div>`;
                    listDiv.appendChild(div);
                });
                document.getElementById('loadModal').style.display = 'flex';
            } else { alert("Nincs f√°jl a mapp√°ban."); }
            showLoading(false);
        }

        async function loadFileContent(fileId) {
            document.getElementById('loadModal').style.display = 'none'; showLoading(true);
            try {
                const response = await gapi.client.drive.files.get({ fileId: fileId, alt: 'media' });
                editor.setValue(response.body); addToOutput("F√°jl bet√∂ltve.", "success");
            } catch(e) { addToOutput("Hiba bet√∂lt√©skor.", "error"); }
            showLoading(false);
        }
        
        function showLoading(show) { document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none'; }

        // --- PYODIDE ---
        let pyodide = null; let pyodideReady = false; let inputResolver = null;
        const outputElement = document.getElementById("output");

        async function initPyodide() {
            try {
                pyodide = await loadPyodide();
                await pyodide.runPythonAsync(`
import js
import asyncio
import sys

async def custom_input(p=""):
    if p:
        print(p, end="")
        sys.stdout.flush()
    return str(await js.waitForInput())
                `);
                pyodideReady = true;
            } catch (e) { console.error(e); }
        }
        initPyodide();

        const inputBar = document.getElementById("terminal-input-bar");
        const inputField = document.getElementById("term-input");
        window.waitForInput = () => new Promise(resolve => { inputResolver = resolve; inputBar.style.display = "flex"; inputField.value = ""; inputField.focus(); });
        inputField.addEventListener("keydown", (e) => { e.stopPropagation(); if (e.key === "Enter" && inputResolver) { const val = inputField.value; inputBar.style.display = "none"; addToOutput(val + "\n", "user-input"); inputResolver(val); inputResolver = null; editor.focus(); } });

        function addToOutput(text, cls="") {
            const s = document.createElement("span"); s.textContent = text; if(cls) s.className = cls;
            outputElement.appendChild(s); outputElement.scrollTop = outputElement.scrollHeight;
        }

        async function runPython() {
            if(!pyodideReady) return; outputElement.textContent = "";
            let code = editor.getValue().replace(/\binput\s*\(/g, "await custom_input(");
            try {
                pyodide.setStdout({ batched: (m) => addToOutput(m) }); pyodide.setStderr({ batched: (m) => addToOutput(m) });
                await pyodide.runPythonAsync(`
import asyncio
async def w():
    try:
${code.split('\n').map(l => '        ' + l).join('\n')}
    except Exception as e:
        print(e)
await w()
                `);
            } catch(e) { addToOutput(e, "error"); }
        }

        function downloadCode() {
            let code = editor.getValue(); let filename = prompt("F√°jln√©v?", "program");
            if (filename) { if (!filename.endsWith(".txt")) filename += ".txt"; const blob = new Blob([code], { type: 'text/plain' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename; document.body.appendChild(a); a.click(); document.body.removeChild(a); }
        }

        function openSettings() { document.getElementById("settingsModal").style.display = "flex"; }
        function closeSettings() { document.getElementById("settingsModal").style.display = "none"; }
        function saveSettings() { closeSettings(); }

        let isDark=true;
        function toggleTheme() { isDark = !isDark; document.body.className = isDark ? "" : "light-mode"; editor.setOption("theme", isDark ? "dracula" : "eclipse"); }
    </script>
</body>
</html>
